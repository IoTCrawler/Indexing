import sympy as sp
from numpy import reshape
from numpy import asarray, transpose, array, linalg, abs, cov, var,  mean, ceil
from sklearn.externals import joblib
import pymongo
from operator import itemgetter

# Reading the data from the database

# list of sensors from the database
sensorIDList = [183593,
                161167,
                180165,
                159174,
                159703,
                182214,
                182234,
                182224,
                180151,
                182210,
                180143,
                180123,
                180141,
                160818,
                159874,
                159780,
                182204,
                159534,
                180167,
                173587,
                182198,
                180135,
                178660,
                160779,
                160456,
                160378,
                182230,
                180147,
                180175,
                180149,
                180137,
                180139,
                180159,
                182244,
                183577,
                180161,
                182206,
                180171,
                180121,
                159952,
                180157,
                159103,
                182240,
                182196,
                161215,
                159382,
                182238,
                182212,
                159619,
                182200,
                186215,
                182194,
                180163,
                186201,
                186211,
                182222,
                182232,
                180127,
                182236,
                161140,
                1811,
                189670,
                189672,
                981740,
                229120,
                189674,
                178662,
                189664,
                189748,
                180155,
                189698,
                229569,
                229168,
                189742,
                229136,
                229212,
                189744,
                229535,
                229152,
                229513,
                229122,
                229138,
                229531,
                229555,
                192400,
                229553,
                850286,
                229505,
                229467,
                229539,
                172904,
                229537,
                229140,
                229156,
                229134,
                189680,
                229473,
                229154,
                186255,
                189700,
                229178,
                229116,
                189750,
                229130,
                229114,
                189660,
                192364,
                189686,
                189694,
                192406,
                229132,
                186241,
                229180,
                189732,
                189682,
                192358,
                229164,
                183585,
                180153,
                189690,
                186233,
                229571,
                189696,
                229216,
                229230,
                229445,
                189684,
                189662,
                186229,
                186239,
                192342,
                189702,
                192336,
                229202,
                192346,
                189668,
                192348,
                189688,
                229240,
                192352,
                229451,
                182226,
                189756,
                186247,
                229515,
                229525,
                186237,
                229459,
                229487,
                189704,
                229477,
                182216,
                186243,
                229509,
                229220,
                186231,
                229475,
                186235,
                183597,
                229499,
                186257,
                229463,
                183579,
                183601,
                229461,
                160088,
                186245,
                229439,
                229112,
                183603,
                192334,
                229431,
                160867,
                229435,
                173427,
                180173,
                229447,
                229188,
                160897,
                192382,
                186195,
                192372,
                182246,
                192394,
                192392,
                182248,
                229160,
                229441,
                229194,
                180133,
                229449,
                186223,
                180131,
                229437,
                229192,
                229232,
                183589,
                229108,
                229429,
                180169,
                183607,
                192380,
                182208,
                189736,
                192374,
                229076,
                183591,
                161062,
                182202,
                180129,
                180125,
                192396,
                183595,
                229068,
                229595,
                173718,
                192408,
                229501,
                182218,
                180145,
                172116,
                172457,
                229098,
                171762,
                229090,
                182228,
                186219,
                229072,
                189758,
                229082,
                229186,
                189720,
                229084,
                229184,
                183599,
                229096,
                229198,
                229086,
                229080,
                229142,
                229100,
                186207,
                229208,
                229104,
                182220,
                186227,
                186199,
                229150,
                183583,
                229074,
                183605,
                186205,
                229603,
                186225,
                229519,
                186209,
                186203,
                229200,
                186221,
                186213,
                183609,
                186197,
                183581,
                186217,
                229455,
                229549,
                189712,
                229615,
                229126,
                189752,
                229507,
                229647,
                229182,
                229623,
                192368,
                229625,
                189708,
                229657,
                189714,
                229645,
                229663,
                229453,
                229607,
                850284,
                229665,
                229433,
                229609,
                189692,
                229457,
                229669,
                229627,
                229427,
                229102,
                229653,
                229601,
                229170,
                229491,
                229545,
                229593,
                850282,
                229483,
                192398,
                229575,
                229118,
                229469,
                189676,
                229529,
                189716,
                229228,
                229176,
                229579,
                229649,
                229605,
                229517,
                229158,
                229631,
                229533,
                229128,
                229224,
                186249,
                229611,
                229573,
                229162,
                229234,
                229166,
                229110,
                229671,
                192344,
                229124,
                229577,
                186251,
                192402,
                229471,
                189678,
                183587,
                229174,
                229543,
                229495,
                189718,
                192386,
                189710,
                229527,
                229521,
                229489,
                189706,
                229479,
                229681,
                192388,
                229617,
                189746,
                229465,
                229493,
                229659,
                189738,
                229218,
                229619,
                229547,
                189734,
                229503,
                229190,
                189740,
                229511,
                229559,
                229204,
                189754,
                229523,
                229563,
                229078,
                229443,
                186253,
                229485,
                192390,
                229242,
                189666,
                229196,
                229557,
                192332,
                160926,
                229589,
                229210,
                229641,
                182242,
                229677,
                229222,
                229597,
                189724,
                192404,
                229236,
                229583,
                189728,
                192360,
                229206,
                189726,
                192340,
                229481,
                229587,
                189722,
                229561,
                192356,
                192384,
                229226,
                229585,
                229675,
                189730,
                229092,
                192378,
                229633,
                172300,
                192376,
                229591,
                160983,
                192366,
                229567,
                229629,
                182252,
                192370,
                229651,
                229599,
                183575,
                192350,
                229106,
                229070,
                229214,
                192653,
                206290,
                161251,
                183117,
                229541,
                203716,
                201696,
                209986,
                203530,
                229088,
                229661,
                161028,
                190393,
                158386,
                229565,
                192338,
                229655,
                229551,
                229643,
                229637,
                229673,
                229639,
                192362,
                229667,
                229635,
                192354,
                229613,
                201481,
                203636,
                229172,
                206449,
                187324,
                197598,
                229679,
                173118,
                187085,
                179282,
                186953,
                198330,
                193376,
                178929,
                190073,
                193402,
                197760,
                193132,
                181223,
                229238,
                179336,
                190421,
                192466,
                197302,
                187059,
                158655,
                198085,
                197922,
                229621,
                195096,
                184945,
                184729,
                197463,
                185263,
                192919,
                187271,
                193106,
                187589,
                206396,
                195418,
                161115,
                203663,
                193159,
                229094,
                158715,
                180655,
                229425,
                229581,
                229497]
# Todo: Get the latest reading from the past 24 hrs then sort it by REPORT_ID
myclient = pymongo.MongoClient("mongodb://localhost:27017/")
mydb = myclient["iotcrawler"]
mycol = mydb["realTimeTraffic"]


def lagrangian(sample):
    sample = asarray(sample)
    lag = list()
    for j in range(0, sample.shape[1]):
        vector = sample[:, j]
        l = len(vector)
        lam = sp.symbols('lambda', real=True)
        g = -1
        for i in range(0, l):
            g += (vector[i]/(2*lam)) ** 2
        stationary_points = sp.solve(g, lam)
        lamb = max(stationary_points)
        vector = asarray(vector)
        lag.append(vector/(2 * lamb))
    return lag


def pca_calculator(sample, step):
    pca = None
    sample = asarray(sample)
    if sample.shape[0] == step:
        cov_mat = cov(transpose(sample))
        eig_vals, eig_vecs = linalg.eig(cov_mat)
        eig_pairs = [(abs(eig_vals[i]), eig_vecs[:, i]) for i in range(len(eig_vals))]
        eig_pairs.sort(key=itemgetter(0))
        eig_pairs.reverse()
        pr = eig_pairs[0]
        pca = pr[1]

    return array(pca)


def create_pattern(sample):
    # input is a sample with chosen columns depend on the model and row_number=step and output is the index
    step = 12
    sample = asarray(sample)
    lag = lagrangian(sample)
    pca = pca_calculator(lag, step)
    pca = asarray(pca)
    return pca.astype(float)



def clustering(sample, modelname):
    # input is a sample with chosen columns depend on the model and modelname is a string which ends with .sav
    # modelname is in the form of model_domain(column1,column2,...).sav
    model = joblib.load(modelname)
    sample_index = create_pattern(sample)
    sample_index = reshape(sample_index, (1, -1))
    label = model.predict(sample_index)
    if modelname == 'models/model_airquality(particullate,nitrogen).sav':
        if label == 1:
            print("High risk")
        elif label == 0:
            print("Low risk")
        elif label == 2:
            print("Medium risk")
        return label

    elif modelname == 'models/model_traffic(avgTime,avgSpeed).sav':
        if label == 1:
            print("Low Traffic")
        elif label == 0:
            print("Medium Traffic")
        elif label == 2:
            print("High Traffic")
        return label

    elif modelname == 'models/model_wind(speed,vane).sav':
        if label == 1:
            print("Strong")
        elif label == 0:
            print("Light")
        elif label == 2:
            print("Medium")
        return label


data = []
for document in sensorIDList:
    myQuery = {"REPORT_ID": document}
    queryResults = mycol.find(myQuery).limit(12)
    for doc in queryResults:
        data.append(doc)

readings = []
for document in data:
    sensor = document.get('REPORT_ID')
    avgTime = document.get('avgMeasuredTime')
    avgSpeed = document.get('avgSpeed')
    readings.append(list((avgTime, avgSpeed)))


lookupRange = 12
temp = []
for index in range(len(readings) - lookupRange + 1):
    temp.append(readings[index:index + lookupRange])

for x in temp:
    print(len(x))
    pred = clustering(x, 'models/model_traffic(avgTime,avgSpeed).sav')
    print(pred)

